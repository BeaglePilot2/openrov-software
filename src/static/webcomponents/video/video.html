<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="rov-video">
  <template>
    <style type="text/css">
      #container {
        height: 100%;
        width: 100%;
      }

      #video {
        border: 2px solid black;
        background-color: black;
        max-width: 100%;
        vertical-align: middle;
        height: 100%;
      }

      #videoCanvas {
        width: 100%;
      }

      .hidden {
      display: none;
      visibility: hidden;
      }
    </style>

    <div id="container">
      <img class="hidden" id="video" src="../../themes/OpenROV/img/no_camera.jpg"/>
      <canvas id='videoCanvas'></canvas>
    </div>

  </template>
  <script>
    (function() {

      var socket = window.io.connect();
      var srcAddress = undefined;
      socket.on('videoStarted', function (data) {
        var address = 'http://' + socket.io.engine.hostname + ':' + CONFIG.video_port + '/?action=stream';
        srcAddress = address;
        console.log('video enabled');
      });
      socket.on('VideoStopped', function (data) {
        srcAddress = undefined;
        console.log('video stopped');
      });


      Polymer({
        intervall: undefined,
        attached: function () {

          var canvas = this.$.videoCanvas;
          var srcImg = this.$.video;
          var videocontainer = $(this.$.container);

          var startRendering = function () {
            $(srcImg).attr('src', srcAddress);
            this.intervall = setInterval(function () {
              var width = videocontainer.innerWidth();
              var height = videocontainer.innerHeight();
              canvas.width = width;
              canvas.height = height;
              var ctx = canvas.getContext('2d');
              ctx.fillRect(0, 0, canvas.width, canvas.height);
              var proportionalHeight = width * srcImg.height / srcImg.width;


              try {
                ctx.drawImage(srcImg, 0, (canvas.height - proportionalHeight) / 2, width, proportionalHeight);
              }
              catch (e) {
              }
            }, 64);  //only need to redraw at the framerate of source video
          };

          if (srcAddress) {
            startRendering();
          }
          else {
            socket.once('videoStarted', function() {
              startRendering();
            });
            socket.on('VideoStopped', function() {
              clearInterval(this.intervall);
            })
          }
        },
        detached: function() {
          clearInterval(this.intervall);
        }
      });
    })();
  </script>

</polymer-element>
  


